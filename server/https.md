# HTTPS

要使用`HTTPS`必须要申请证书. 证书的签发一般需要交钱, 但也有免费的[Let's Encrypt](https://letsencrypt.org).

有两种方式, 一种是`SSH`登录服务器手动执行命令获取, 一种是从云主机商(支持`Let's
Encrypt`)免费获取. 要说明的是, 一般国内的云主机商都不支持.

第一种, 通过`SSH`登录后, 执行软件(运行`ACME`协议)获取, 一般使用[Certbot](https://certbot.eff.org). 在首页
选择操作系统和`http`服务器.

安装: `sudo apt install letsencrypt`.

执行: `letsencrypt certonly --webroot -w /var/www/html -d example.com -d www.example.com`

`-w`指定你的网站根目录, `-d`指定域名, 可多个. 之后会要求你输入用于恢复的邮箱和同意
协议, 即可获取证书, 存放在`/etc/letsencrypt/archive/`目录中. 可能包含`cert.pem`证书,
`chains.pem`, `fullchains.pem`, `privkey.pem`私钥.

这里解释下什么是`chains`. 这也涉及证书的原理. 

公钥私钥的加密机制: 假设A/B两方需要通信, 每方都有自己的公私钥. 通信过程为, A使用
B的公钥加密信息, 发送给B, B使用自己的私钥解密信息. B使用A的公钥加密回复给A的信息,
A收到信息后用自己的私钥解密信息. OK, 希望你明白这个过程, 虽然可能不理解原理, 但
知道这样做可以保证通信的安全即可.

如果A/B认识彼此, 曾在某次见面时交换了彼此的公钥, 那么A/B即可安全通信. 但问题是, 
这在互联网上是不可能做到的. 以`jd.com`为例, 安全通信的前提是获取`jd.com`的公钥,
问题是如何确认你访问时获取的是`jd.com`的公钥. 这里可能涉及一个信息安全方面的知识.
一种方案时, 一个权威机构用自己的私钥为`jd.com`的公钥加密(虽然证书还包含别的方面,
但最主要的就是服务器的公钥), 当你访问`jd.com`时获取到证书, 然后用权威机构的公钥
解密证书, 以获得`jd.com`的公钥. 这里的问题有两点, 一点是权威机构要只为真正的`jd.com`
加密, 第二点是你有权威机构的公钥. 第一点不说了, 申请证书是很费劲的事, 经过一系列
线下的流程可以保证, 第二点, 你可能问, 我没从哪个网站下载过权威机构的公钥啊? 即使
我下载了, 我既然无法保证获取的`jd.com`的公钥是真的, 又如何确保获取的权威机构的
公钥是真的. 如何你仔细想想这点, 就会发现这其实是一个信任链的问题. 好不第二点不
用你操心, 因为操作系统已经帮助你做了, 操作系统把重要的权威机构的证书全部内置为
根证书后才发行的. 证书是很重要的, 确保了当前互联网能安全地通信. 这也说明两点:
一是不要随便安装/信任根证书, 二是不要随便安装非官方发布的操作系统. 当然, 对普通
人而言, 实在没必要活的这么累.

权威机构只有有限个, 而`let's Encrypt`并不是权威机构, 那怎么办. 一种方法是, `Lets`
拥有权威机构给它签发的证书, 然后它再用自己的私钥给别人签发证书. 当然这个链条可以
一直进行下去. 也就是, 可能有多级的证书签发机构, 不过越往下越不安全而已. 对于`Lets`
而言, 也就是你向`Lets`为自己的域名申请证书, 由于它自己不是根权威机构, 所以在向你
签发证书后, 也会把权威机构给它签发的证书也一并给你, 就像在说, 瞧, 我可以被XX认证的.

对于某些浏览器, 可能会对这种中间证书略有微词, 一种方式是将`Lets`自身的证书合并到
它签发的证书后面, `cat chains.pem >> cert.pem`, 别一种是直接用`fullchains.pem`.
在我的试验中, 直接用`cert.pem`即可.

用`openssl s_client -connect www.enali.cn:443`命令来确保服务器发送了完整的证书链.
在结果中, `#k`的机构证书被`#k+1`的机构签发. `#0`是你服务器证书的直接签发机构.

但`Lets Encrypt`签发的证书有个问题, 只有90天有效期, 也就是说, 每90天就需要申请一
次. 一种方式是, 把这个作为`cron`让服务器自动执行.

以`root`用户执行`crontab -e`编辑`crontab`文件, 可能需要添加环境变量`EDITOR=vim`,
添加`0 0,12 */90 * * /usr/bin/letsencrypt renew`, 意为每90天, 在`0:00`和`12:00`
执行更新命令.
